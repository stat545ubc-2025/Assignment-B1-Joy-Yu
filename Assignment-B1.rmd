---
title: "Assignment-B1-STAT545B"
output: github_document
---

## Function

When working on the mini data analysis, since the dataset I used
includes lots of data, I had to narrow down the range that I looked
into. When deciding which subset to look into, the summary information
of different groups is a key factor. Thus, I think it would be helpful
to have a summary function that can be used repeatedly.

```{r}
# import libraries
suppressPackageStartupMessages(library(tidyverse))
suppressPackageStartupMessages(library(rlang))
suppressPackageStartupMessages(library(roxygen2))
suppressPackageStartupMessages(library(testthat))
```

Here's the function:

```{r}
#' Summarise the dataset by group
#' 
#' For each group, calculate the number of rows, numeric columns' mean value
#' and categorical columns' number of unique values
#' 
#' @param data dataset to summarise
#' @param ... ellipses, column(s) to group by
#' 
#' @return the summary result
group_summary <- function(data, ...) {

    # check if the input data is a data frame or tibble
    if (!is.data.frame(data)){
        stop("Input must be a data frame or tibble.")
    }

    vars <- ensyms(...)                 # get the arguments as symbols
    for (var in vars) {
        # check if the arguments are columns in data
        if (!(as_string(var) %in% names(data))) {
            stop(paste("Column", as_string(var), "does NOT exist in the dataset"))
        }
    }

    summary_info <- data %>%
        drop_na() %>%                   # drop rows with missing data
        group_by(...) %>%               # group by the input column(s)
        summarise(
            # calculate the mean value for numeric columns
            across(where(is.numeric), ~mean(.x), .names="mean_{.col}"),
            # calculate the number of unique values for categorical columns
            across(where(is.factor), ~n_distinct(.x), .names = "num_of_unique_{.col}"),
            n = n(),                    # calculate the row number
        )
    
    return(summary_info)
}
```

## Examples

Below shows the examples of how to use the function with the dataset `penguins`. The first parameter
is the data frame or table, and the others are the columns in the data that you would like to group by with.

```{r, message=FALSE}
summary_info = group_summary(penguins, species, island)

# set n and width to Inf to show the full result
print(summary_info, n = Inf, width = Inf)
```

The following example shows that if the first input argument is not a data frame, the function will
return an error with an error message.

```{r, error=TRUE}
penguin = c(1, 2, 3)

# penguin is not a data frame or tibble
summary_info = group_summary(penguin, species)
```

The third example shows if the input column doesn't exist in the dataset, the function will
return an error with a corresponding error message.

```{r, error=TRUE}
# spe doesn't exist in the data
summary_info = group_summary(penguins, spe, island)
```

The last example shows that if there is no other columns arguments specified, the function will
apply the summarise to the whole table.

```{r}
print(group_summary(penguins), n=Inf, width=Inf)
```

# Test the Function

Use `testthat` package to test the `group_summary` function.

```{r}
test_that("group_summary function works well for different kinds of input", {
    # example 1: test that the output is correct with no input columns
    # creat the correct answer first
    penguins_removed_na <- penguins %>% drop_na()
    answer <- tibble(
        mean_bill_len = mean(penguins_removed_na$bill_len),
        mean_bill_dep = mean(penguins_removed_na$bill_dep),
        mean_flipper_len = mean(penguins_removed_na$flipper_len),
        mean_body_mass = mean(penguins_removed_na$body_mass),
        mean_year = mean(penguins_removed_na$year),
        num_of_unique_species = length(unique(penguins_removed_na$species)),
        num_of_unique_island = length(unique(penguins_removed_na$island)),
        num_of_unique_sex = length(unique(penguins_removed_na$sex)),
        n = nrow(penguins_removed_na)
    )
    expect_equal(group_summary(penguins), answer)

    # example 2: test that the function runs into an error when the input is not
    # a data frame or tibble
    vec = c(1, 2, 3)
    expect_error(group_summary(vec, species))

    # example 3: test that the function runs into an error when the input column
    # does not exist in the dataset
    expect_error(group_summary(penguins, specie))
})
```


